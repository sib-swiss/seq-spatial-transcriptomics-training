{
  "hash": "b27bda14bedabb1ffdf55bffdfb89ad6",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Exercise 7\"\nformat: html\neditor: source\neditor_options: \n  chunk_output_type: console\n---\n\n\n## Differential analysis with multi-sample\n\nIn this exercise, we extend our analysis to multi-sample, multi-condition spatial transcriptomics data. With multiple samples per condition (e.g., 2 colorectal carcinoma (CRC) and 2 normal adjacent tissues), we can ask not only: \n\n> \"Is a gene spatially variable within a tissue?\" \n\nbut also: \n\n> \"Does its spatial pattern change between conditions?\" \n\nGenes showing such changes are called **differential spatial patterns (DSP)** genes. Using the `DESpace` package, we will learn how to identify such genes, that may be spatially variable in one condition but not in another, or it could be spatially variable in both conditions, but with different spatial patterns.\n\n\n## Learning Objectives\n\nBy the end of this exercise, you will be able to:\n\n  - Understand the concept of DSP\n  - Perform global DSP tests across multiple samples  \n  - Perform individual-cluster tests to find cluster-specific DSP genes  \n  - Interpret the DSP patterns \n\n# Libraries\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(HDF5Array) \nlibrary(SingleCellExperiment)\nlibrary(SpatialExperiment)\nlibrary(ggspavis)\nlibrary(patchwork)\nlibrary(DESpace)\n```\n:::\n\n\n## Load preprocessed data\n\nWe will work with the same VisiumHD dataset from the human colon cancer study [recently published](https://www.nature.com/articles/s41588-025-02193-3). Here we use a subsetted dataset containing 4 slides from three patients (P1CRC, P5CRC, P3NAT, and P5NAT), representing either colorectal carcinoma (CRC) or normal adjacent tissues (NAT), all with pre-computed clusters.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspe <- loadHDF5SummarizedExperiment(dir=\"data/Human_Colon_Cancer_P1/\", prefix=\"02.3_spe_tmp\")\n\n# Remove mitochondrial genes\ngn <- rowData(spe)$Symbol\nmt <- grepl(\"^MT-\", gn, ignore.case = TRUE)\ntable(mt)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nmt\nFALSE  TRUE \n18034    11 \n```\n\n\n:::\n\n```{.r .cell-code}\nspe <- spe[!mt, ]\n\n# Extract sample labels\nsample_id <- colData(spe)[[\"sample_id\"]]\n\n# Create a sample indicator matrix\n# Each column represents a sample; entries are 1 if the spot belongs to that sample\nsample_mat <- model.matrix(~ sample_id - 1)\n \n# Total counts of each gene in each sample\ngene_counts <- counts(spe)\ncounts_per_sample <- gene_counts %*% sample_mat\n\n# Number of non-zero spots per gene per sample\nnonzero_per_sample <- (gene_counts > 0) %*% sample_mat \n\n# Keep only genes that pass the filter in all samples\nsel_matrix <- t(counts_per_sample >= 50 & nonzero_per_sample >= 20)\nsel <- colMeans(sel_matrix) == 1\nspe <- spe[sel, ]\n\n# Normalization\nspe <- scuttle::logNormCounts(spe)\nspe\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass: SpatialExperiment \ndim: 12114 56120 \nmetadata(0):\nassays(2): counts logcounts\nrownames(12114): SAMD11 NOC2L ... TMLHE VAMP7\nrowData names(3): ID Symbol Type\ncolnames(56120): s_016um_00145_00029-1.Normal_P5\n  s_016um_00165_00109-1.Normal_P5 ... s_016um_00122_00096-1.Normal_P3\n  s_016um_00127_00062-1.Normal_P3\ncolData names(6): row col ... sample_id sizeFactor\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(0):\nspatialCoords names(2) : pxl_col_in_fullres pxl_row_in_fullres\nimgData names(4): sample_id image_id data scaleFactor\n```\n\n\n:::\n:::\n\n\n`colData(spe)` includes: \n\n  - `sample_id`: sample ID \n  - `condition`: CRC vs. Normal tissue \n  - `cluster`: spatial domain labels\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(colData(spe), 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDataFrame with 3 rows and 6 columns\n                                      row       col  cluster condition\n                                <integer> <integer> <factor>  <factor>\ns_016um_00145_00029-1.Normal_P5       145        29       3     Normal\ns_016um_00165_00109-1.Normal_P5       165       109       9     Normal\ns_016um_00188_00060-1.Normal_P5       188        60       10    Normal\n                                sample_id sizeFactor\n                                 <factor>  <numeric>\ns_016um_00145_00029-1.Normal_P5 Normal_P5   2.309698\ns_016um_00165_00109-1.Normal_P5 Normal_P5   3.266692\ns_016um_00188_00060-1.Normal_P5 Normal_P5   0.938006\n```\n\n\n:::\n\n```{.r .cell-code}\ntable(spe$condition)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCancer Normal \n 29064  27056 \n```\n\n\n:::\n:::\n\n\nVisualize clusters for each sample.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsamples <- sort(unique(spe$sample_id))\nlapply(samples, \\(.)\n       plotCoords(spe[, spe$sample_id == .],\n                  annotate=\"cluster\",\n                  in_tissue=NULL,\n                  point_size = 0.1) +\n         ggtitle(.)) |>\n  wrap_plots(nrow = 2) &\n  scale_color_manual(values=unname(pals::trubetskoy())) &\n  theme_void() &\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](day2-3_differential_spatial_pattern_files/figure-html/unnamed-chunk-4-1.png){width=384}\n:::\n:::\n\n\n\n## DESpace\n\n### Global test\n\nTo answer the question: does the expression of a gene change between conditions, but change differently for some domains compared to others?\n\n`DESpace::dsp_test()` first aggregates spot- or cell-level counts into pseudobulk counts for each (sample, domain) combination, then tests whether the interaction term (condition x domain) in the model is different from zero.\n\n> Take few minutes to run. While it is running, take a look at the [package vignette](https://peicai.github.io/DESpace/articles/DSP.html).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres_edgeR <- dsp_test(spe,\n                      cluster_col = \"cluster\",\n                      sample_col = \"sample_id\",\n                      condition_col = \"condition\",\n                      verbose = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nUsing 'dsp_test' for spatial variable pattern genes detection.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nFilter low quality clusters: \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCluster levels to keep: 0, 2, 3, 4, 5, 6, 8, 9, 10, 11, 13, 14, 16, 17\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nDesign model: row names represent sample names, followed by underscores and cluster names.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n            (Intercept) conditionNormal cluster_id10 cluster_id11 cluster_id13\nCancer_P1_0           1               0            0            0            0\nCancer_P5_0           1               0            0            0            0\n            cluster_id14 cluster_id16 cluster_id17 cluster_id2 cluster_id3\nCancer_P1_0            0            0            0           0           0\nCancer_P5_0            0            0            0           0           0\n            cluster_id4 cluster_id5 cluster_id6 cluster_id8 cluster_id9\nCancer_P1_0           0           0           0           0           0\nCancer_P5_0           0           0           0           0           0\n            conditionNormal:cluster_id10 conditionNormal:cluster_id11\nCancer_P1_0                            0                            0\nCancer_P5_0                            0                            0\n            conditionNormal:cluster_id13 conditionNormal:cluster_id14\nCancer_P1_0                            0                            0\nCancer_P5_0                            0                            0\n            conditionNormal:cluster_id16 conditionNormal:cluster_id17\nCancer_P1_0                            0                            0\nCancer_P5_0                            0                            0\n            conditionNormal:cluster_id2 conditionNormal:cluster_id3\nCancer_P1_0                           0                           0\nCancer_P5_0                           0                           0\n            conditionNormal:cluster_id4 conditionNormal:cluster_id5\nCancer_P1_0                           0                           0\nCancer_P5_0                           0                           0\n            conditionNormal:cluster_id6 conditionNormal:cluster_id8\nCancer_P1_0                           0                           0\nCancer_P5_0                           0                           0\n            conditionNormal:cluster_id9\nCancer_P1_0                           0\nCancer_P5_0                           0\n```\n\n\n:::\n:::\n\n\n::: callout-important\n## Exercise 1\n\nCheck out the results:\n\n- Extract gene-level results.\n- Count how many DSP genes are significant at 5\\% FDR.\n- Take the top 3 DSP genes and visualize their spatial expression across all samples using `ggspavis::plotCoords()`.\n- How would you describe the spatial expression patterns of these genes? To help with interpretation, try looking up information about these genes (e.g., UniProt or the Human Protein Atlas) to get clues about which cell types or tissue domains they may highlight.\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Answer\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Extract gene-level results\ndsp_global <- res_edgeR$gene_results\nhead(dsp_global, 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        gene_id logFC.conditionNormal.cluster_id10\nSPIB       SPIB                          3.4415851\nSLITRK6 SLITRK6                          3.7154399\nUBE2C     UBE2C                          0.3256397\n        logFC.conditionNormal.cluster_id11 logFC.conditionNormal.cluster_id13\nSPIB                             -5.983395                         -0.4236515\nSLITRK6                          -5.075883                          0.4888250\nUBE2C                             2.249840                         -2.5062421\n        logFC.conditionNormal.cluster_id14 logFC.conditionNormal.cluster_id16\nSPIB                              6.151715                         -5.7511426\nSLITRK6                          -6.603245                          0.5934225\nUBE2C                             9.622368                         -4.8662120\n        logFC.conditionNormal.cluster_id17 logFC.conditionNormal.cluster_id2\nSPIB                             0.4004018                         -1.255224\nSLITRK6                          7.0008848                          3.086543\nUBE2C                            4.0294337                          1.098661\n        logFC.conditionNormal.cluster_id3 logFC.conditionNormal.cluster_id4\nSPIB                             1.160759                          2.046807\nSLITRK6                          2.686996                          1.267288\nUBE2C                            3.088812                          3.277094\n        logFC.conditionNormal.cluster_id5 logFC.conditionNormal.cluster_id6\nSPIB                             5.217929                        -0.5678032\nSLITRK6                          3.306325                         2.2850045\nUBE2C                            1.463769                         4.5273828\n        logFC.conditionNormal.cluster_id8 logFC.conditionNormal.cluster_id9\nSPIB                            3.1284376                          2.316966\nSLITRK6                         5.4204477                         -1.086872\nUBE2C                           0.2789153                          4.335590\n          logCPM        F       PValue         FDR\nSPIB    5.752220 6.337809 3.350024e-07 0.003687506\nSLITRK6 5.038332 6.030911 5.512791e-07 0.003687506\nUBE2C   4.731840 5.944750 9.567813e-07 0.004266607\n```\n\n\n:::\n\n```{.r .cell-code}\n# Count significant DSP genes (at 5% FDR significance level)\ntable(dsp_global$FDR <= 0.05)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nFALSE  TRUE \n13365    13 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Top 3 DSP genes\ngs <- rownames(dsp_global)[seq_len(3)]\ngs\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"SPIB\"    \"SLITRK6\" \"UBE2C\"  \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplots <- lapply(samples, \\(s) {\n  # Subset to sample s\n  spe_j <- spe[, spe$sample_id == s]\n  \n  # Plot cluster \n  p_cluster <- plotCoords(\n    spe_j,\n    annotate = \"cluster\",\n    in_tissue = NULL,\n    point_size = 0.05,\n    legend_position = \"none\") +\n    ggtitle(s) +\n    scale_color_manual(values = unname(pals::trubetskoy()))\n  \n  # Plots for each DSP gene\n  p_genes <- lapply(gs, \\(g) {\n    plotCoords(\n      spe_j,\n      annotate = g,\n      point_size = 0.05,\n      in_tissue = NULL,\n      assay_name = \"logcounts\",\n      feature_names = \"Symbol\"\n    ) +\n      scale_color_gradientn(colors = pals::brewer.reds(n=12))\n  })\n  \n  # combine the cluster plot and 3 gene plots\n  c(p_cluster, p_genes)\n})\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\n```\n\n\n:::\n\n```{.r .cell-code}\nplots_flat <- unlist(plots, recursive = FALSE)\nwrap_plots(plots_flat, ncol = 4)\n```\n\n::: {.cell-output-display}\n![](day2-3_differential_spatial_pattern_files/figure-html/unnamed-chunk-7-1.png){width=864}\n:::\n:::\n\n:::\n\n### Individual domain test\n\nThe global test tells us which genes show different spatial patterns globally, but it does not tell us which clusters drive the differences.\n\nTo identify the key spatial domain where expression changes across conditions, we use `DESpace::individual_dsp()`, which performs domain-specific DSP tests.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Focus on one cluster to decrease runtime in this exercise\nspe$c8 <- factor(ifelse(spe$cluster == \"8\", 1, 0))\ndsp_clu <- individual_dsp(spe,\n                      cluster_col = \"c8\",\n                      sample_col = \"sample_id\",\n                      condition_col = \"condition\",\n                      filter_gene = FALSE,\n                      test = \"LRT\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nConducting tests for layer '0' against all other layers.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nDesign model: row names represent sample names, followed by underscores and cluster names.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                (Intercept) conditionNormal cluster_id0\nCancer_P1_Other           1               0           0\nCancer_P5_Other           1               0           0\n                conditionNormal:cluster_id0\nCancer_P1_Other                           0\nCancer_P5_Other                           0\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nConducting tests for layer '1' against all other layers.\n\nDesign model: row names represent sample names, followed by underscores and cluster names.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                (Intercept) conditionNormal cluster_id1\nCancer_P1_Other           1               0           0\nCancer_P5_Other           1               0           0\n                conditionNormal:cluster_id1\nCancer_P1_Other                           0\nCancer_P5_Other                           0\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nReturning results\n```\n\n\n:::\n:::\n\n\n::: callout-important\n## Exercise 2\n\n- Extract the 4th top DSP gene.\n- Visualize its expression across samples via `ggspavis::plotCoords()` or `DESpace::FeaturePlot()` and interpret the result.\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Answer\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Select cluster id (because after binarization cluster 8 = \"1\")\nid_clu <- \"1\"\n\n# DSP results for cluster 8\nhead(dsp_clu[[id_clu]], 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          gene_id     logFC   logCPM        F       PValue       FDR\nRNF186     RNF186 -3.330877 4.941428 43.41863 0.0001043483 0.6649003\nVIL1         VIL1 -2.371649 7.117510 36.91333 0.0002551964 0.6649003\nSIGLEC10 SIGLEC10  2.567324 5.554622 36.61699 0.0002614359 0.6649003\nCOL12A1   COL12A1 -2.543965 6.903958 35.37749 0.0002945338 0.6649003\nDDAH1       DDAH1 -1.978593 7.162494 35.05049 0.0003042777 0.6649003\n```\n\n\n:::\n\n```{.r .cell-code}\n# dsp_clu[[\"1\"]] stores DSP genes for cluster 8  (after binarization)\n# dsp_clu[[\"0\"]] stores DSP genes for all other regions (not useful here)\n# If full clusters are used originally, dsp_clu[[\"8\"]] would store cluster 8 results\n\n# Select the 4th top DSP genes\n(gs <- rownames(dsp_clu[[id_clu]])[4])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"COL12A1\"\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Rotate slices\ncolData(spe) <- colData(spe) |> cbind(spatialCoords(spe))\nspe$row <- spe$pxl_col_in_fullres\nspe$col <- -spe$pxl_row_in_fullres\n\n# Visualization\nplots <- lapply(samples, \\(.) {\n  # Subset sample\n  spe_j <- spe[, colData(spe)$sample_id == .]\n  # FeaturePlot for cluster 8\n  plot <- FeaturePlot(spe_j, \n                      feature = gs, \n                      coordinates = c(\"pxl_row_in_fullres\", \"pxl_col_in_fullres\"),\n                      cluster_col = \"c8\", # binary cluster column\n                      cluster = \"1\",      # plot on cluster 8\n                      platform = \"VisiumHD\",\n                      sf_dim = 400,\n                      diverging = TRUE,\n                      point_size = 0.05,\n                      linewidth = 0.6) +\n    theme(legend.position = \"right\") +\n    labs(color = \"\") + ggtitle(.) \n  \n  return(plot)\n})\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCoordinate system already present.\nℹ Adding new coordinate system, which will replace the existing one.\nCoordinate system already present.\nℹ Adding new coordinate system, which will replace the existing one.\nCoordinate system already present.\nℹ Adding new coordinate system, which will replace the existing one.\nCoordinate system already present.\nℹ Adding new coordinate system, which will replace the existing one.\n```\n\n\n:::\n\n```{.r .cell-code}\nwrap_plots(plots, ncol = 2) + plot_layout(guides = 'collect') + ggtitle(gs)\n```\n\n::: {.cell-output-display}\n![](day2-3_differential_spatial_pattern_files/figure-html/unnamed-chunk-10-1.png){width=768}\n:::\n:::\n\n\nIn CRC samples, COL12A1 shows higher expression in cluster 8 and covers a larger region.\nIn normal samples, its expression is weaker and more limited.\n\nCluster 8 might correspond to a stromal region that becomes expanded or remodeled in CRC.\n`individual_dsp()` helps identify which spatial domain shows condition-specific changes in gene expression.\n:::\n\n::: callout-important\n## Bonus question\nTry running the individual domain test using the default setting `test = \"QLF`. How do the results change? (Hint: check the number of significant genes.) Why might this happen?\n:::\n\nClear your environment:\n\n::: {.cell}\n\n```{.r .cell-code}\nrm(list = ls())\ngc()\n.rs.restartR()\n```\n:::\n\n\n:::{.callout-important}\n**Key Takeaways:**\n\n- DSP genes capture changes in where a gene is expressed across conditions, not only how much.\n\n- `dsp_test()` identifies global DSP genes across all clusters and samples.\n\n- `individual_dsp()` pinpoints which clusters (spatial domains) drive these differences.\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}