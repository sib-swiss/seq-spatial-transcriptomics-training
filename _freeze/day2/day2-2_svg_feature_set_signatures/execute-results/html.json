{
  "hash": "d53265bc3e48c063785366e54b1e80a6",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Exercise 6\"\nformat: html\neditor: source\neditor_options: \n  chunk_output_type: console\nbibliography: ../references.bib\n---\n\n## Spatial Variable Genes (SVGs) and Feature-set Signatures\n\nIn this practical exercise, we focus on spatially structured gene expression, pathway-level signatures. We will calculate SVGs using two families of methods, compare SVGs to HVGs, understand how spatial information influences downstream analysis, and quantify pathway activities using gene-set scoring.\n\n## Learning Objectives\n\nBy the end of this exercise, you will be able to:\n\n- Identify SVGs with two types of methods\n- Compare SVGs to HVGs \n- Score cells/spots with gene-set signatures and interpret spatial pathway patterns\n\n# Libraries\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(HDF5Array) \nlibrary(SpatialExperiment)\nlibrary(scran) # HVG selection\n\nlibrary(nnSVG)   # SVGs\nlibrary(DESpace) # SVGs \n\nlibrary(AUCell)  # Gene set scoring\nlibrary(msigdbr) # Gene sets\nlibrary(pals)    # Color palette\n\nlibrary(ggplot2)\nlibrary(ggspavis)\nlibrary(patchwork)\nlibrary(pheatmap)\n```\n:::\n\n\n## Load and Prepare Data\n\nWe begin by loading the `SpatialExperiment` object prepared in the previous exercise containing clustering results.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspe <- loadHDF5SummarizedExperiment(dir=\"results/day1\", prefix=\"01.4_spe\")\n```\n:::\n\n\n## Spatially variable genes (SVGs)\n\nIn Day 1, we performed the analyses using the set of most highly variable genes (HVGs), which capture overall transcriptional variability and are useful for identifying major sources of variation and reducing dimensionality. HVGs reflect global heterogeneity, but they do not use spatial information. \n\nIn spatial transcriptomics, however, we are often interested in genes whose expression changes across tissue in structured spatial patterns. These are called spatially variable genes (SVGs), which conceptually generalize HVGs by adding spatial information.\n\nSVG inference methods differ in how they use spatial coordinates and what types of spatial structure they detect. They can be broadly grouped into three categories [@yan2025svg]:\n\n- **Overall SVGs** detect any spatial pattern across the tissue; can be used for feature selection for downstream analyses (e.g., spatially-aware clustering)\n\n- **Spatial domain-specific SVGs** identify genes whose expression differs between spatial domains, using domains as a proxy for spatial information\n\n- **Cell type-specific SVGs** use external cell type annotations to identify spatially structures expression within cell types.\n\nIn this exercise, we will focus on the first two categories, using `nnSVG`[@weber2023nnsvg] for overall SVGs and `DESpace`[@cai2024despace] for domain-specific SVGs.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\n# Sample 100 spots to decrease runtime in this exercise\nn <- 100\nsub <- spe[, sample(ncol(spe), n)]\nrowData(sub)$gene_name <- rowData(sub)$Symbol\n\n# Subset to a subset of 200 HVGs, to further decrease runtime\nhvg_idx <- which(rowData(spe)$hvg)[seq_len(200)]\nsub <- sub[hvg_idx, ]\n\n# Remove genes with all zeros on this subset of spots\nkeep_genes <- rowSums(counts(sub)) > 0\nsub <- sub[keep_genes, ]\n\n# Remove lowly expressed genes (expressed in less than 1% of the spots)\nkeep_genes2 <- rowMeans(counts(sub) > 0) >= 0.01 \nsub <- sub[keep_genes2, ]\ndim(sub)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 199 100\n```\n\n\n:::\n\n```{.r .cell-code}\n## Renormalize on this subset of genes \nsub <- logNormCounts(sub)\n```\n:::\n\n\n### nnSVG\n\n`nnSVG` detects SVGs by modeling spatial gene expression using Gaussian processes, capturing smooth gradients or spatial trends. \n\n> Note: `nnSVG` may take up to ~10 minutes to run. Feel free to take a short break and grab a coffee!\n> While it is running, take a look at the [nnSVG paper](https://www.nature.com/articles/s41467-023-39748-z) and the [package vignette](https://bioconductor.org/packages/devel/bioc/vignettes/nnSVG/inst/doc/nnSVG.html) to better understand how the method works, including its handling of covariates and multiple samples.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\nsub <- nnSVG(sub) \n```\n:::\n\n\n::: callout-important\n## Exercise 1\nInspect the nnSVG output stored in `rowData(sub)`. \n\n- What do the result columns represent? \n- Select the top SVGs detected by `nnSVG`.\n:::\n\n::: {.callout-tip collapse=\"true\"}\n### Answer\n\n::: {.cell}\n\n```{.r .cell-code}\n# Select top SVGs\nres_nnSVG <- rowData(sub) \nres_nnSVG <- res_nnSVG[order(res_nnSVG$pval), ]\nhead(res_nnSVG, 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDataFrame with 3 rows and 20 columns\n                    ID      Symbol            Type subsets_Mito       hvg\n           <character> <character>        <factor>    <logical> <logical>\nPIGR   ENSG00000162896        PIGR Gene Expression        FALSE      TRUE\nLEFTY1 ENSG00000243709      LEFTY1 Gene Expression        FALSE      TRUE\nCXCR4  ENSG00000121966       CXCR4 Gene Expression        FALSE      TRUE\n         gene_name  sigma.sq      tau.sq       phi    loglik   runtime\n       <character> <numeric>   <numeric> <numeric> <numeric> <numeric>\nPIGR          PIGR  2.392157 2.39216e-08   6.99998 -149.7420     0.033\nLEFTY1      LEFTY1  0.192993 1.92993e-09  10.94084  -37.4109     0.027\nCXCR4        CXCR4  0.802186 3.41954e-01   1.92394 -115.1814     0.023\n            mean       var     spcov   prop_sv loglik_lm   LR_stat      rank\n       <numeric> <numeric> <numeric> <numeric> <numeric> <numeric> <numeric>\nPIGR    0.715634  2.327622   2.16124  1.000000 -183.6337   67.7834         1\nLEFTY1  0.141431  0.230258   3.10618  1.000000  -67.9637   61.1056         2\nCXCR4   0.677274  1.028289   1.32243  0.701126 -142.7862   55.2095         3\n              pval        padj\n         <numeric>   <numeric>\nPIGR   1.88738e-15 3.75588e-13\nLEFTY1 5.38458e-14 5.35766e-12\nCXCR4  1.02662e-12 6.80993e-11\n```\n\n\n:::\n\n```{.r .cell-code}\ntop_nnSVG <- res_nnSVG$gene_name[seq_len(3)]\n```\n:::\n\n\nThe main output is in `rowData` of the `SpatialExperiment` object, which includes: the likelihood ratio statistic (`LR_stat`), the gene’s rank based on this statistic (`rank`), raw p-values from a chi-squared test with 2 degrees of freedom (`pval`), p-values adjusted for multiple testing (`padj`), and the estimated effect size (`prop_sv`), defined as the proportion of spatial variance relative to total variance.\n\n> If you did not run `nnSVG` due to runtime constraints, you may use these pre-computed top SVGs:\n\n::: {.cell}\n\n```{.r .cell-code}\ntop_nnSVG <- c(\"PIGR\", \"LEFTY1\", \"CXCR4\")\n```\n:::\n\n:::\n\n### DESpace\n\n`DESpace` detects genes that show significantly higher/lower expression in one spatial domain compared to the rest of the tissue. To run `DESpace`, we need cluster labels or manual annotation. Here we use pre-computed spatial clusters from the day1, exercise 4.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres <- svg_test(sub, cluster_col=\"Banksy\", verbose = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nusing 'svg_test' for spatial gene/pattern detection.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nFilter low quality genes: \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nmin_counts = 20; min_non_zero_spots = 10.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe number of genes that pass filtering is 57.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nsingle sample test\n```\n\n\n:::\n:::\n\n\n::: callout-important\n## Exercise 2\n\nHave a look at the DESpace results.\n\n- What do each element of the returned list represent? \n- Select top SVGs detected by `DESpace`.\n:::\n\n::: {.callout-tip collapse=\"true\"}\n### Answer\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(res_DESpace <- res$gene_results, 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       gene_id        LR   logCPM       PValue          FDR\nPIGR      PIGR 159.97201 17.05420 1.621055e-30 9.240014e-29\nREG1A    REG1A  96.67773 16.01709 2.035431e-17 5.800979e-16\nS100A6  S100A6  90.39713 16.53597 3.862476e-16 7.338704e-15\n```\n\n\n:::\n\n```{.r .cell-code}\ntop_DESpace <- res_DESpace$gene_id[seq_len(3)]\n```\n:::\n\n\nThe main output is in `gene_results`: a `data.frame` containing: gene name (`gene_id`), likelihood ratio test statistics (`LR`), average (across spots) log-2 counts per million (`logCPM`), raw p-values (`PValue`) and Benjamini-Hochberg adjusted p-values (`FDR`).\n:::\n\n### Comparing HVGs and SVGs\n\nAs we did yesterday, we first model gene variance using a Poisson noise model with `scran::modelGeneVarByPoisson()` and select the top HVGs.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndec <- modelGeneVarByPoisson(spe)\ntop_HVG <- row.names(dec[order(dec$bio, decreasing = T), ])[1:3]\ntop_HVG\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"IGKC\"   \"MT-CO3\" \"MT-CO2\"\n```\n\n\n:::\n:::\n\n\n::: callout-important\n## Exercise 3\n\n- Visualize the expression patterns of the top genes from each list via `ggspavis::plotCoords()`. \n- What types of biological signals does each category capture?\n:::\n\n::: {.callout-tip collapse=\"true\"}\n### Answer\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngs <- c(\n    nnSVG=top_nnSVG,\n    DESpace=top_DESpace,\n    HVGs=top_HVG)\n# Expression plots for each top gene\nps <- lapply(seq_along(gs), \\(.) {\n    plotCoords(spe,\n        point_size=0,\n        annotate=gs[.],\n        assay_name=\"logcounts\",\n        feature_names=\"Symbol\")\n})\nwrap_plots(ps, nrow=3) & theme(\n    legend.key.width=unit(0.4, \"lines\"),\n    legend.key.height=unit(0.8, \"lines\")) &\n    scale_color_gradientn(colors = pals::parula())\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\nScale for colour is already present.\nAdding another scale for colour, which will replace the existing scale.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](day2-2_svg_feature_set_signatures_files/figure-html/day2-2-svg-feature-set-signatures-10-1.png){width=672}\n:::\n:::\n\n:::\n\n::: callout-important\n## Bonus question\nTry using SVGs for dimensionality reduction (e.g., PCA) and clustering (e.g., Leiden clustering, BayesSpace, Banksy) as seen yesterday (exercises 3 and 4). How do clustering results differ compared to using HVGs? \n:::\n\n## Feature-set signatures\n\nSo far, we have focused on single genes. We now consider gene set signatures, which summarize activity of pathways or biological program.\n\nHere we will use `AUCell`[@aibar2017scenic], which works in two main steps: (i) rank genes for every cell/spot, and (ii) compute an AUC score per (spot, gene set) pair, roughly reflecting the fraction of high-ranking genes that belong to a given set.\nHigh AUC values correspond to high coordinated expression of the gene set.\n\n### Retrieve `MSigDB` Hallmark gene sets\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Retrieve hallmark gene sets from 'MSigDB'\ndb <- msigdbr(species=\"Homo sapiens\", category=\"H\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: The `category` argument of `msigdbr()` is deprecated as of msigdbr 10.0.0.\nℹ Please use the `collection` argument instead.\n```\n\n\n:::\n\n```{.r .cell-code}\n# Get list of gene symbols, one element per set\ngs <- split(db$ensembl_gene, db$gs_name)\n\n# Simplify set identifiers (drop prefix, use lower case)\nnames(gs) <- tolower(gsub(\"HALLMARK_\", \"\", names(gs)))\n```\n:::\n\n\n::: callout-important\n## Exercise 4\n\nHow many gene sets are there? What is the range of gene counts across these sets?\n:::\n\n::: {.callout-tip collapse=\"true\"}\n### Answer\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(gs)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 50\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrange(sapply(gs, length))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1]  32 201\n```\n\n\n:::\n:::\n\n:::\n\n### Gene set scoring with `AUCell`\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Realize (sparse) gene expression matrix\nmtx <- as(logcounts(spe), \"dgCMatrix\") \n\n# Use ensembl identifiers as feature names\nrownames(mtx) <- rowData(spe)$ID\n\n# Filter for genes represented in panel\n.gs <- lapply(gs, intersect, rownames(mtx))\n# Keep only those with at least 5 genes\n.gs <- .gs[sapply(.gs, length) >= 5]\n\n# Build per-spot gene rankings\nrnk <- AUCell_buildRankings(mtx, plotStats=FALSE, verbose=FALSE)\n\n# Calculate AUC for each gene set in each spot\nauc <- AUCell_calcAUC(geneSets=.gs, rankings=rnk, verbose=FALSE)\n\n# Add results as spot metadata\ncolData(spe)[rownames(auc)] <- res <- t(assay(auc)) \n```\n:::\n\n\n::: callout-important\n## Exercise 5\n\n- Calculate the percentage of spots with non-zero AUC scores for each gene set (Hint: use `rowMeans()`).\n- Which gene sets are rarely detected? Which ones are mostly detected?\n- Identify the gene set with the highest score variability across spots (Hint: `corVars()`).\n- Visualize this top-scoring set in tissue space via `ggspavis::plotCoords()`.\n- Visualize how signature scores correlated with one another (Hint: compute Spearman correlations and visualize it with `pheatmap()`).\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Answer\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# The percentage of spots with non-zero score across signatures\nfq <- rowMeans(assay(auc) > 0)\nfq <- sort(round(100*fq, 2))\n## Rarely detected\nhead(fq)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       pancreas_beta_cells            notch_signaling \n                     80.86                      83.17 \n        hedgehog_signaling wnt_beta_catenin_signaling \n                     88.61                      91.68 \n            apical_surface               angiogenesis \n                     95.42                      95.66 \n```\n\n\n:::\n\n```{.r .cell-code}\n## Mostly detected\ntail(fq)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\noxidative_phosphorylation               p53_pathway   tnfa_signaling_via_nfkb \n                      100                       100                       100 \n           uv_response_dn            uv_response_up     xenobiotic_metabolism \n                      100                       100                       100 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Subset on highest score variability across spots\n## Variance across spots\nvar <- colVars(res) \n## Top sets\ntop <- names(tail(sort(var), 1)) \n\n# Scale the rows (genes) for better visualization in the heatmap.\nspe[[top]] <- scale(spe[[top]]) \nplotCoords(spe, annotate = top) \n```\n\n::: {.cell-output-display}\n![](day2-2_svg_feature_set_signatures_files/figure-html/day2-2-svg-feature-set-signatures-15-1.png){width=384}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncm <- cor(t(assay(auc)), method=\"spearman\")\npheatmap(cm, \n    breaks=seq(-1, 1, 0.1), \n    color=pals::coolwarm(20), \n    cellwidth=10, cellheight=10)\n```\n\n::: {.cell-output-display}\n![](day2-2_svg_feature_set_signatures_files/figure-html/day2-2-svg-feature-set-signatures-16-1.png){width=672}\n:::\n:::\n\n\nHighly correlated sets will exhibit similar spatial patterns.\n:::\n\nClear your environment:\n\n::: {.cell}\n\n```{.r .cell-code}\nrm(list = ls())\ngc()\n.rs.restartR()\n```\n:::\n\n\n:::{.callout-important}\n**Key Takeaways:**\n\n- HVGs and SVGs emphasize different aspects of the data: HVGs (global heterogeneity); SVGs (spatially structured patterns).\n- Different SVG methods detect different types of structure.\n- Gene set signatures summarize coordinated activity of biological pathways. They can be mapped across the tissue and compared between regions or clusters.\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}