{
  "hash": "7a1792e5d1b9ef2094e28991e8d29f3c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Exercise 3\"\nformat: html\neditor: source\neditor_options: \n  chunk_output_type: console\nexecute:\n  warning: false\n---\n\n## Normalisation, Feature Selection and Dimensionality Reduction\n\nIn this section we will focus on normalisation, feature selection and dimensionality reduction of spatial transcriptomics data, which are important preprocessing steps before downstream analysis such as clustering and marker gene identification. We will focus on the specific challenges and considerations when dealing with spatially-resolved transcriptomics data, as opposed to traditional single-cell RNA-seq data.\n\n## Learning Objectives\n\nBy the end of this exercise, you will be able to:\n\n-   Normalize spatial transcriptomics data to account for technical variations.\n-   Perform feature selection to identify highly variable genes (HVGs).\n-   Apply dimensionality reduction techniques like PCA.\n-   Visualize the results of dimensionality reduction in both reduced dimension space and spatial context.\n\n## Libraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(SpatialExperiment)\nlibrary(scran) \nlibrary(scater) \nlibrary(ggplot2)\nlibrary(patchwork) \nlibrary(bluster)\nlibrary(escheR) \nlibrary(pheatmap)\nlibrary(HDF5Array) \nlibrary(ggspavis)\nlibrary(nnSVG)\nlibrary(Banksy)\nlibrary(igraph)\n```\n:::\n\n\n## Load SpatialExperiment Object\n\nWe will start by loading the `SpatialExperiment` object from the previous exercise, which contains only filtered spots and genes with more than 1 count across all spots.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the SpatialExperiment object from the .qs2 file.\nspe <- loadHDF5SummarizedExperiment(dir=\"results/day1/\", prefix=\"01.2_spe\")\n```\n:::\n\n\n## Normalization\n\nNormalization is a critical step in preprocessing spatial transcriptomics data to account for technical variations and make gene expression levels comparable across spots. We will log normalise raw counts with `scuttle::logNormCounts()`\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Log-normalize counts for downstream analysis\nspe <- logNormCounts(spe)\n```\n:::\n\n\n::: callout-important\n## Exercise 1\nWhat is the name of the new assay added for normalized counts?\n:::\n\n::: {.callout-tip collapse=\"true\"}\n### Answer\n\n::: {.cell}\n\n```{.r .cell-code}\n# Have a look at the assays\nspe@assays\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAn object of class \"SimpleAssays\"\nSlot \"data\":\nList of length 2\nnames(2): counts logcounts\n```\n\n\n:::\n\n```{.r .cell-code}\n# Directly get the assay names(x)\nassayNames(spe)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"counts\"    \"logcounts\"\n```\n\n\n:::\n:::\n\n:::\n\nAfter log-normalization, we can inspect the computed size factors. Size factors are used to account for differences in sequencing depth between spots.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Display a summary of the calculated size factors.\nsummary(sizeFactors(spe))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n 0.1179  0.5081  0.7626  1.0000  1.2766  4.9097 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Visualise the spatial distribution of size factors on the tissue slide.\ncolData(spe)$sizeFactors <- sizeFactors(spe)\nplotVisium(spe, annotate = \"sizeFactors\", zoom = TRUE, point_shape = 22)\n```\n\n::: {.cell-output-display}\n![](day1-3_feature_dimred_cluster_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n::: callout-important\n## Exercise 2\nDo you observe any spatial patterns or gradients for the size factors across the tissue section? What do you think they reflect?\n:::\n\n### Bonus: spatially-aware normalization \nWhile `logNormCounts` provides a general-purpose normalization, specialized spatially-aware normalization methods exist.  These methods aim to correct for technical variations while preserving true spatial biological patterns. Depending on the dataset and research question, exploring such advanced normalization techniques might be beneficial.\n\nIf time is left at the end of this practical, explore the normalization strategy implemented in the `SpaNorm` package.\n\n## Feature Selection\n\n### Highly Variable Genes (HVGs)\n\nSimilar to scRNA-seq analysis, feature selection is a crucial step to focus on genes that show significant biological variation across spots, and thus increase the signal to noise ratio. We typically aim at focusing on \"Highly Variable Genes\" (HVGs) as these are more likely to distinguish different cell types or spatial domains.\n\nIn order to identify HVGs, we will first model the gene variance using a Poisson noise model with `scran::modelGeneVarByPoisson()`\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Model gene variance to identify highly variable genes.\n# This function fits a mean-variance trend to the log-normalized counts.\ndec <- modelGeneVarByPoisson(spe)\n## Sort by biological variance\ndec <- dec[order(dec$bio, decreasing = T), ]\n\n# Visualize the mean-variance relationship and the fitted trend.\n# This plot helps to understand how gene variability changes with expression level.\nplot(dec$mean, dec$total,\n  xlab = \"Mean expression (log-counts)\",\n  ylab = \"Total variance (log-counts)\",\n  main = \"Mean-Variance Trend\"\n)\ncurve(metadata(dec)$trend(x), add = TRUE, col = \"dodgerblue\", lwd = 2)\n```\n\n::: {.cell-output-display}\n![](day1-3_feature_dimred_cluster_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n::: callout-important\n## Exercise 3\nHow do you interpret this plot, compared to similar ones generated from scRNA-seq datasets?\n:::\n\nOnce we have modeled the gene variance, we can proceed to select the top HVGs. \nFor demonstration purposes, we will visualize the expression patterns of the top 6 HVGs on the tissue slide. We exclude the mitochondrial genes, since those genes tend to be highly variable but do not provide much information about cell types or spatial domains.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# identify mitochondrial genes\nis.mito <- rownames(spe)[grepl(\"^MT-\", rownames(spe))]\n\n# Top 6 HVGs\ntop_HVG <- row.names(dec[!row.names(dec) %in% is.mito, ])[1:6]\ntop_HVG\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"IGKC\"   \"OLFM4\"  \"IGHG1\"  \"COL3A1\" \"PIGR\"   \"COL1A1\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# Create a plot for each gene in top_HVG\nps <- lapply(top_HVG, \\(.) {\n    plotCoords(spe, \n        annotate = ., \n        assay_name = \"logcounts\") }) # use \"logcounts\" assay to visualise log normalised counts\n\n# figure arrangement and change colors\npatchwork::wrap_plots(ps, nrow = 2) & \n  theme(legend.key.width = unit(0.4, \"lines\"), \n        legend.key.height = unit(0.8, \"lines\")) & \n  scale_color_gradientn(colors = rev(hcl.colors(9, \"Rocket\")))\n```\n\n::: {.cell-output-display}\n![](day1-3_feature_dimred_cluster_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n::: callout-important\n## Exercise 4\nHow would you define the spatial expression patterns of these genes? Look a bit for some information on these genes (e.g., on the Uniprot website) to get a hint at which cell types and domains they could highlight.\n:::\n\nFor downstream analysis, we define a larger group of HVG and add the information of whether a genes is in the HVG list or not in a `rowData` slot:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Select the top 1000 highly variable genes.\nhvg <- getTopHVGs(dec, n = 1000) \n\n# Store HVG information in rowData\nrowData(spe)$hvg <- rowData(spe)$Symbol %in% hvg\n\n# Display the range of biological variation for the selected HVGs\ndec[hvg, ]$bio |> summary()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n0.01639 0.02102 0.02923 0.08608 0.05341 4.55267 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Have a look a the new column added\nrowData(spe)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDataFrame with 17952 rows and 5 columns\n                     ID      Symbol            Type subsets_Mito       hvg\n            <character> <character>        <factor>    <logical> <logical>\nSAMD11  ENSG00000187634      SAMD11 Gene Expression        FALSE     FALSE\nNOC2L   ENSG00000188976       NOC2L Gene Expression        FALSE     FALSE\nKLHL17  ENSG00000187961      KLHL17 Gene Expression        FALSE     FALSE\nPLEKHN1 ENSG00000187583     PLEKHN1 Gene Expression        FALSE     FALSE\nPERM1   ENSG00000187642       PERM1 Gene Expression        FALSE     FALSE\n...                 ...         ...             ...          ...       ...\nMT-ND4L ENSG00000212907     MT-ND4L Gene Expression         TRUE      TRUE\nMT-ND4  ENSG00000198886      MT-ND4 Gene Expression         TRUE      TRUE\nMT-ND5  ENSG00000198786      MT-ND5 Gene Expression         TRUE      TRUE\nMT-ND6  ENSG00000198695      MT-ND6 Gene Expression         TRUE      TRUE\nMT-CYB  ENSG00000198727      MT-CYB Gene Expression         TRUE      TRUE\n```\n\n\n:::\n:::\n\n\n### Spatially Variable Genes (SVGs)\n\nWe will go very quickly over this topic, which will be discussed in depth tomorrow. Today, the idea is to get an intuition about the difference between HVGs and SVGs. For this, we select randomly 6 other HVGs from the list, and plot their expression:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Select randomly 6 HVGs\nset.seed(123)\nrandom_HVG <- sample(hvg, size = 6)\n\n# Create a plot for each gene in top_HVG\nps <- lapply(random_HVG, \\(.) {\n    plotCoords(spe, \n        annotate = ., \n        assay_name = \"logcounts\") }) # use \"logcounts\" assay to visualise log normalised counts\n\n# figure arrangement and change colors\npatchwork::wrap_plots(ps, nrow = 2) & \n  theme(legend.key.width = unit(0.4, \"lines\"), \n        legend.key.height = unit(0.8, \"lines\")) & \n  scale_color_gradientn(colors = rev(hcl.colors(9, \"Rocket\")))\n```\n\n::: {.cell-output-display}\n![](day1-3_feature_dimred_cluster_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n::: callout-important\n## Exercise 5\nHow would you define the spatial expression patterns of these genes? What is the difference with genes at the top of the list? Which ones would you qualify as SVGs?\n:::\n\n## Dimensionality Reduction (DR)\nThereafter we make use of the highly variable genes (HVGs) to perform dimensionality reduction and clustering.\n\n### Non-spatially aware DR:\n\n#### PCA\n\nWe can perform dimensionality reduction using Principal Component Analysis (PCA) on the log-normalized expression values of the HVGs. This method is agnostic to spatial information, and focuses solely on capturing the main axes of variation in the gene expression data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Run PCA on the log-normalized counts of the HVGs\nspe <- runPCA(spe, ncomponents = 30, subset_row = rowData(spe)$hvg)\n\n# Visualize the explained variance by each principal component.\n# This helps in determining how many PCs capture most of the variance.\nplot(attr(reducedDim(spe, \"PCA\"), \"percentVar\"),\n  xlab = \"PC\", ylab = \"Proportion of variance explained\",\n  main = \"PCA Scree Plot\"\n)\n```\n\n::: {.cell-output-display}\n![](day1-3_feature_dimred_cluster_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n::: callout-important\n## Exercise 6\nBased on the scree plot, how many principal components would you consider for downstream analysis? Why? \n\nBonus: You can also have look at the `scran::getDenoisedPCs` function to help you make this choice.\n:::\n\n::: {.callout-tip collapse=\"true\"}\n### Answer\nWe can select the first 10 PCs for downstream analysis, as they seem to capture a significant proportion of the variance in the data before the explained variance starts to level off.\n:::\n\nChoose the number of PCs accordingly for downstream analysis. Visualize the PCs on the tissue slice coordinates.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Run PCA on the log-normalized counts of the HVGs using the top PCs, for example 10 PCs\nspe <- runPCA(spe, ncomponents = 10, subset_row = rowData(spe)$hvg)\n\n# Get the PCA results \npcs <- reducedDim(spe, \"PCA\")\n# Visualize PCs on the tissue slice coordinates\nps <- lapply(colnames(pcs), \\(.) {\n    spe[[.]] <- pcs[, .]\n    plotCoords(spe, annotate = .)\n}) \n# Arrange the plots and customize colors\npatchwork::wrap_plots(ps, nrow = 2) & \n  theme(legend.key.width = unit(0.4, \"lines\"), \n        legend.key.height = unit(0.8, \"lines\")) & \n  scale_color_gradientn(colors = rev(hcl.colors(9, \"Rocket\")))\n```\n\n::: {.cell-output-display}\n![](day1-3_feature_dimred_cluster_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n::: callout-important\n## Exercise 7\nWhat do you notice? How do you interpret it?\n\n## Bonus Exercise\nExtract the genes most associated with one of these PCs\n:::\n\n::: {.callout-tip collapse=\"true\"}\n### Answer\n\nWe observe a strong correlation between the PCs scores and the expression patterns observed above for the top HVGs, suggesting that they refelct cell type or domain biology.\n\nTo extract the 10 genes most associated to PC2: \n\n::: {.cell}\n\n```{.r .cell-code}\nattributes(reducedDims(spe)[[\"PCA\"]])$rotation[, \"PC2\"] |> abs() |> sort(decreasing = TRUE) |> names() |> head(n=10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"COL3A1\" \"COL1A1\" \"COL1A2\" \"CXCR4\"  \"CD74\"   \"IGKC\"   \"MMP2\"   \"TXNIP\" \n [9] \"A2M\"    \"SPARC\" \n```\n\n\n:::\n:::\n\n:::\n\n### Spatially aware DR:\n\n#### Banksy\n\nWe can also perform spatially aware dimensionality reduction using the `Banksy` method, which integrates spatial coordinates and gene expression into the PCA framework. This allows us to capture spatial patterns in the data while reducing dimensionality. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 'Banksy' parameter settings\nk <- 20   # consider first order neighbors\nl <- 0.8 # use spatial information with weight lambda\na <- \"logcounts\" # assay to use\nxy <- c(\"array_row\", \"array_col\")  # spatial coordinate names\n\n# compute spatially aware 'Banksy' PCs, using the HVGs only\nset.seed(112358)\ntmp <- computeBanksy(spe[rowData(spe)$hvg, ], \n                     assay_name=a, \n                     coord_names=xy, \n                     k_geom=k, \n                     parallel=T,\n                     num_cores=4)\ntmp <- runBanksyPCA(tmp, \n                    lambda=l, \n                    npcs=10)\nreducedDim(spe, \"PCA_banksy\") <- reducedDim(tmp, \"PCA_M0_lam0.8\") # store 'Banksy' PCs in original object\n```\n:::\n\n\n::: callout-important\n## Exercise 8\nWhile this is running, have a look at the [Banksy paper](https://www.nature.com/articles/s41588-024-01664-3) to understand better what the method is doing.\n\nHave a look at the spe object to see the dimensionality reduction slots. How many dimensionality reductions are stored now? What are their names and what do they represent?\n:::\n\n::: {.callout-tip collapse=\"true\"}\n### Answer\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspe\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass: SpatialExperiment \ndim: 17952 12615 \nmetadata(2): resources spatialList\nassays(2): counts logcounts\nrownames(17952): SAMD11 NOC2L ... MT-ND6 MT-CYB\nrowData names(5): ID Symbol Type subsets_Mito hvg\ncolnames(12615): s_016um_00144_00175-1 s_016um_00204_00145-1 ...\n  s_016um_00193_00227-1 s_016um_00109_00223-1\ncolData names(36): barcode in_tissue ... sizeFactor sizeFactors\nreducedDimNames(3): PCA_artifacts PCA PCA_banksy\nmainExpName: Gene Expression\naltExpNames(0):\nspatialCoords names(2) : pxl_col_in_fullres pxl_row_in_fullres\nimgData names(4): sample_id image_id data scaleFactor\n```\n\n\n:::\n\n```{.r .cell-code}\nreducedDimNames(spe)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"PCA_artifacts\" \"PCA\"           \"PCA_banksy\"   \n```\n\n\n:::\n:::\n\n\nThere are now three dimensionality reductions stored in the `spe` object: :\"PCA_artifacts\", \"PCA\" and \"PCA_banksy\". \"PCA_artifacts\" was computed to capture technical artifacts in a previous exercise (QC step).\n\n\"PCA\" represents the non-spatially aware principal components, while \"PCA_banksy\" represents the spatially aware principal components computed using the Banksy method. Both methods have used HVGs for dimensionality reduction.\n:::\n\nIn the same way as before, we can visualise the Banksy PCs on the tissue slice coordinates.\n\n::: callout-important\n## Exercise 9\nSelect PCs from Banksy dimensionality reduction space and visualise them on the tissue slice. Do you observe any spatial patterns? How do they compare to the non-spatial PCs?\n:::\n\n::: {.callout-tip collapse=\"true\"}\n### Answer\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Visualize PCs on the tissue slice coordinates\npcs <- reducedDim(spe, \"PCA_banksy\")\nps <- lapply(colnames(pcs), \\(.) {\n    spe[[.]] <- pcs[, .]\n    plotCoords(spe, annotate = .)\n}) \npatchwork::wrap_plots(ps, nrow = 2) & \n  theme(legend.key.width = unit(0.4, \"lines\"), \n        legend.key.height = unit(0.8, \"lines\")) & \n  scale_color_gradientn(colors = rev(hcl.colors(9, \"Rocket\")))\n```\n\n::: {.cell-output-display}\n![](day1-3_feature_dimred_cluster_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n:::\n\n\n::: callout-important\n## Bonus Exercise\nTry to change Banksy parameters k and lambda. How does it affect the results?\n:::\n\n\n## Run UMAP\n\nFor visualization purposes only, we'll produce UMAPs based on on both spatially aware and not spatially aware PCA results:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# UMAP\nspe <- runUMAP(spe, dimred=\"PCA\", name=\"UMAP_tx\")\nspe <- runUMAP(spe, dimred=\"PCA_banksy\", name=\"UMAP_banksy\")\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Visualise\nplotReducedDim(spe, dimred = \"UMAP_tx\", colour_by = \"detected\") + \n  scale_colour_gradient(trans = \"log\", high = \"yellow\", low = \"red\")\n```\n\n::: {.cell-output-display}\n![](day1-3_feature_dimred_cluster_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n\n```{.r .cell-code}\nplotReducedDim(spe, dimred = \"UMAP_banksy\", colour_by = \"detected\") +\n    scale_colour_gradient(trans = \"log\", high = \"yellow\", low = \"red\")\n```\n\n::: {.cell-output-display}\n![](day1-3_feature_dimred_cluster_files/figure-html/unnamed-chunk-17-2.png){width=672}\n:::\n:::\n\n\n::: callout-important\n## Bonus question\nIf you tried different parameters for Banksy, how does it affect the UMAP results?\n:::\n\n\n## Save data for later\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspe_HVG <- spe\nsaveHDF5SummarizedExperiment(spe_HVG, dir=\"results/day1\", prefix=\"01.3_spe\", replace=TRUE,\n                                chunkdim=NULL, level=NULL, as.sparse=NA,\n                                verbose=NA)\n```\n:::\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}