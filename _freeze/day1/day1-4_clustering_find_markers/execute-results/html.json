{
  "hash": "813890cc630f6b1213b465b6255a7331",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Exercise 4\"\nformat: html\neditor: source\neditor_options: \n  chunk_output_type: console\nexecute:\n  warning: false\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(Banksy)\nlibrary(igraph)\nlibrary(ggspavis)\nlibrary(BayesSpace)\nlibrary(nnSVG)\nlibrary(HDF5Array) # For loading object\nlibrary(patchwork)\nlibrary(SpatialExperiment)\nlibrary(scran) \nlibrary(scater)\nlibrary(scrapper)\nlibrary(SingleR)\nlibrary(qs2)\nlibrary(viridis)\nlibrary(RColorBrewer)\nlibrary(pheatmap)\n```\n:::\n\n\n\n## Clustering and Spatially-aware clustering\n\nIn the next section we will explore clustering methods for spatial transcriptomics data, including classical non-spatially aware and spatially-aware approaches. \n\n## Learning Objectives\nBy the end of this exercise, you will be able to:\n\n-  Perform non-spatially aware clustering using graph-based methods (Leiden clustering).\n-  Perform spatially-aware clustering using Bayesian modeling (BayesSpace) and graph-based methods (Banksy + Leiden).\n-  Visualize and compare clustering results from different methods on tissue slides.\n\n## Clustering\n\nLoad the previously saved `SpatialExperiment` object which contains information on the HVGs and dimensionationality reduction computed with Banksy and PCA.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspe <- loadHDF5SummarizedExperiment(dir=\"results/day1\", prefix=\"01.3_spe\")\n```\n:::\n\n\n\n### Non-spatial aware clustering\n\nClustering methods can be categorized into non-spatially aware, classically used for scRNA-seq analysis, and spatially-aware methods. We will first explore non-spatially aware clustering using graph-based methods.\n\n#### Leiden clustering\n\nAs commonly done in single-cell RNA-seq analysis, we can perform graph-based clustering using the Leiden algorithm on a shared nearest-neighbor (SNN) graph constructed from the PCA results.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# build cellular shared nearest-neighbor (SNN) graph\ng <- buildSNNGraph(spe, use.dimred=\"PCA\", type=\"jaccard\", k=20)\n# cluster using Leiden community detection algorithm\nk <- cluster_leiden(g, objective_function=\"modularity\", resolution=0.6)\n# assign cluster labels to spe object\nspe$Leiden <- factor(k$membership)\ntable(spe$Leiden)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n   1    2    3    4    5    6    7 \n1844 1471 1459 2238 2302 2201 1100 \n```\n\n\n:::\n:::\n\n\n\n### Spatialy aware clustering\n\nClustering methods can also incorporate spatial information to identify spatial domains or regions in the tissue. Here we will explore two different approaches: Bayesian modeling (probabilistic) and spatially-aware graph-based clustering.\n\n#### Probabilistic: BayesSpace\n\nWe can use the `BayesSpace` package to perform spatially aware clustering using a Bayesian modeling approach.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# prepare data for 'BayesSpace'\n# skipping PCA (already computed)\nspe <- spatialPreprocess(spe, skip.PCA=TRUE)\n# perform spatial clustering with 'BayesSpace'\n# using 'd=10' PCs and targeting 'q=8' clusters\nspe <- spatialCluster(spe, q=8, d=10, nrep=1e3, burn.in=100) \nspe$BayesSpace <- factor(spe$spatial.cluster)\ntable(spe$BayesSpace)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n   1    2    3    4    5    6    7    8 \n1796  524 1716 2495 2592  816 1681  995 \n```\n\n\n:::\n:::\n\n\n\n#### Graph-based: Banksy\n\nWe have computed spatially-aware principal components using Banksy already in the previous practical. We will now used these to perform SNN graph-based Leiden clustering, in order to obtain spatially-aware clusters.\nWhen building the SNN graph, we will use the same parameters we have used before for the non-spatially aware graph.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# perform SNN graph-based clustering on 'Banksy' PCs using\ng <- buildSNNGraph(spe, use.dimred=\"PCA_banksy\", type=\"jaccard\", k=20)\n# cluster using Leiden community detection algorithm\nk <- cluster_leiden(g, objective_function=\"modularity\", resolution=0.6)\nspe$Banksy <- factor(k$membership)\ntable(spe$Banksy)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n   1    2    3    4    5    6    7    8    9 \n1481 1154 1395 1214 2379 1922  953 1565  552 \n```\n\n\n:::\n:::\n\n\n\n## Visualisation of the different clustering methods:\n\nLet's visualize the clustering results from the different methods on the tissue slide.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Define the three clustering methods to compare\nks <- c(\"BayesSpace\", \"Leiden\", \"Banksy\") \n# Plot spatial distribution of clusters for each method\nplots <- c(lapply(ks, \\(.) {\n    plt <- plotVisium(spe, annotate=., zoom = T, point_shape = 22, point_size = 1)\n    plt\n}) ,  \n  plotVisium(spe, zoom = T,  spots=FALSE )) # add a plot of the tissue without spots\n# combine plots\nplots |>  wrap_plots(nrow=2) &\n      scale_fill_brewer(palette = \"Set1\") &\n    theme(legend.key.size=unit(0, \"lines\"), legend.justification=\"left\")\n```\n\n::: {.cell-output-display}\n![](day1-4_clustering_find_markers_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nIt can help us to visualise the clusters one by one, in order to better see their spatial distribution. We take as an example the Banksy clusters:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# plot selected clusters in order of frequency,\n# highlighting cells assigned to cluster 'k'\nlapply(tail(names(sort(table(spe$Banksy))), 8), \\(k) {\n    spe$foo <- spe$Banksy == k\n    spe <- spe[, order(spe$foo)]\n    plt <- plotCoords(spe, annotate=\"foo\")\n    plt$layers[[1]]$aes_params$stroke <- 0\n    plt$layers[[1]]$aes_params$size <- 0.2\n    plt + ggtitle(k)\n}) |>\n    wrap_plots(nrow=3) &\n    scale_color_manual(values=c(\"white\", \"red\")) &\n    theme(plot.title=element_text(hjust=0.5), legend.position=\"none\")\n```\n\n::: {.cell-output-display}\n![](day1-4_clustering_find_markers_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n::: callout-important\n## Exercise 1\nVisualise the clusters obtained with the 3 methods, and compare their spatial distribution. What do you observe?\n:::   \n\n\n## Perform cell-type annotation of the spots\n\nWe'll use the annotation of the scRNA-seq dataset (10X FLEX technology) generated along with the VisiumHD used in the practicals (See the record on [GEO](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE280311) and the related [Github repository](https://github.com/10XGenomics/HumanColonCancer_VisiumHD/tree/main)). We subsetted this reference dataset to 5,000 cells.\n\nTo annotate each spot, we use the `SingleR()` method, which uses a correlation-based approach comparing test cells (here: spots) to reference samples with known cell-type annotation.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nref.se = qs_read(\"data/Human_Colon_Cancer_P1/NatGenetics2025_CRC_5k.SE.qs\")\ntable(colData(ref.se)$labels)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n              B cells           Endothelial            Fibroblast \n                  316                   308                   868 \nIntestinal Epithelial               Myeloid              Neuronal \n                  523                   599                   296 \n        Smooth Muscle               T cells                 Tumor \n                  649                   351                  1090 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Predict cell-type using SingleR \npred <- SingleR(test   = logcounts(spe),\n                ref    = assay(ref.se, \"data\"), # log-normalized counts        \n                labels = ref.se$labels,\n                aggr.ref = TRUE,                # pseudo-bulk aggregation of reference labels  \n                fine.tune = FALSE,              # for faster computation here\n)\nspe$SingleR_label <- pred$pruned.labels\ntable(spe$SingleR_label)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n              B cells           Endothelial            Fibroblast \n                 1007                   840                  3340 \nIntestinal Epithelial               Myeloid              Neuronal \n                 1633                   656                    66 \n        Smooth Muscle               T cells                 Tumor \n                  505                  1570                  2991 \n```\n\n\n:::\n\n```{.r .cell-code}\n# visualize the predictions on the tissue slide.\nplotCoords(spe, annotate=\"SingleR_label\", point_shape = 15, point_size = 1) + \n  scale_colour_brewer(palette = \"Set1\")\n```\n\n::: {.cell-output-display}\n![](day1-4_clustering_find_markers_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n\n```{.r .cell-code}\nplotVisium(spe, annotate=\"SingleR_label\", zoom = T, point_shape = 22, point_size = 1) + \n  scale_fill_brewer(palette = \"Set1\")\n```\n\n::: {.cell-output-display}\n![](day1-4_clustering_find_markers_files/figure-html/unnamed-chunk-8-2.png){width=672}\n:::\n:::\n\n\n::: callout-important\n## Exercise 2\nWhat do you think about this annotation? Do you identify potentially relevant biological structures? How are these isolated above in the calculated clusters and spatial domains? \n:::\n\n:::{.callout-tip collapse=\"true\"}\n### Answer\n\nLet's compare to the Leiden cluster for example:\n\n::: {.cell}\n\n```{.r .cell-code}\ntab_prop <- prop.table(table(spe$Leiden, spe$SingleR_label), margin = 1)\n## For display: round and remove 0s\nnum_mat <- round(tab_prop, 2)\nnum_mat[num_mat == 0] <- \"\"\n\n## Annotation colors\ngroup_df = data.frame(row.names = colnames(tab_prop), SingleR_label=colnames(tab_prop))\nann_colors = list(\n  SingleR_label = setNames(object = brewer.pal(9, \"Set1\"), colnames(tab_prop)))\n\npheatmap(\n  tab_prop,\n  cluster_rows = TRUE,\n  cluster_cols = TRUE,\n  color = viridis(100, option = \"magma\", direction = -1)[0:50],\n  display_numbers = num_mat,\n  fontsize_number = 10,\n  fontsize = 12,\n  border_color = NA,\n  main = \"Leiden clusters vs. SingleR labels\", \n  annotation_col = group_df,\n  annotation_colors = ann_colors  \n)\n```\n\n::: {.cell-output-display}\n![](day1-4_clustering_find_markers_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n## Save the object\n\nSave the `SpatialExperiment` object for the next steps:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveHDF5SummarizedExperiment(spe, dir=\"results/day1\", prefix=\"01.4_spe\", replace=TRUE,\n                                chunkdim=NULL, level=NULL, as.sparse=NA,\n                                verbose=NA)\n```\n:::\n\n\nClear your environment:\n\n::: {.cell}\n\n```{.r .cell-code}\nrm(list = ls())\ngc()\n.rs.restartR()\n```\n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}