{
  "hash": "abad27a9a9221ec53a1c45d88c159759",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Exercise 1\"\nformat: html\neditor: source\neditor_options: \n  chunk_output_type: console\n---\n\n## Learning Objectives\n\nBy the end of this exercise, you will be able to:\n\n-   Understand the structure of a `SpatialExperiment` object.\n-   Access and interpret `spatialCoords` and `imgData`.\n-   Perform basic subsetting operations on `SpatialExperiment` objects.\n-   Combine multiple `SpatialExperiment` objects.\n-   Apply image transformations (rotation, mirroring) to spatial data.\n\n## Libraries\n\n\n::: {.cell}\n\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load necessary R libraries for spatial transcriptomics data analysis.\nlibrary(SpatialExperiment)\nlibrary(VisiumIO)\nlibrary(arrow)\nlibrary(qs2)\nlibrary(ggspavis)\nlibrary(patchwork)\nlibrary(dplyr)\nlibrary(arrow)\nlibrary(scuttle)\nlibrary(HDF5Array)\n```\n:::\n\n\n## Data for the course\n\nWe will start with downloading the data. We will work on a VisiumHD dataset from a human colon cancer study [published recently](https://www.nature.com/articles/s41588-025-02193-3). A Visium HD slide from one patient (P2CRC) used in the article is available [from the 10X website](https://www.10xgenomics.com/datasets/visium-hd-cytassist-gene-expression-libraries-of-human-crc). We will focus on the \"binned output\" provided available as an output of the Space Ranger pipeline. \n\nThe dataset contains normal adjacent tissue (NAT) and colorectal carcinoma (CRC) from 5 patients.  \nWe will start downloading and processing one of the Human colon cancer samples (P1).   \n\n::: callout-important\n## Exercise 1a\n\nHave a look at the paper and 10X website, to find out how was the tissue processed for spatial profiling. How are the transcript molecules measured? \n\nWhich version of the Space Ranger tool was used to process the data, and what is the output folders containing? This page will be useful: https://www.10xgenomics.com/support/software/space-ranger/latest/analysis/outputs/output-overview. Additionally the Space Ranger \"web summary\" gives a good idea about the quality of the processed sample: https://cf.10xgenomics.com/samples/spatial-exp/3.0.0/Visium_HD_Human_Colon_Cancer/Visium_HD_Human_Colon_Cancer_web_summary.html\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Answer\nThe measurements of RNA molecules is indirect, through capture of ligated probe pairs targeting the whole protein-coding transcriptome.\n\nAn instrument called Visium CytAssist is used to control reagent flow and better capture target probes from the tissue (in particular to limit problematic free diffusion of transcripts).\n\nThe dataset was processed with Space Ranger version 3.0.0. Note that this is not the latest version: v4.0 is the latest and it has cool feature, such as a segmented output.\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (!dir.exists(\"data/Human_Colon_Cancer_P1/binned_outputs/\")) {\n  dir.create(\"data\")\n  download.file(\n    url = \"https://seq-spatial-transcriptomics-training.s3.eu-central-1.amazonaws.com/Human_Colon_Cancer_P1.tar.gz\",\n    destfile = \"data/Human_Colon_Cancer_P1.tar.gz\"\n  )\n\n  untar(\n    tarfile = \"data/Human_Colon_Cancer_P1.tar.gz\", exdir = \"data/\"\n  )\n\n  file.remove(\"data/Human_Colon_Cancer_P1.tar.gz\")\n} else {\n  message(\"Data exists, please proceed to next steps!\")\n}\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nData exists, please proceed to next steps!\n```\n\n\n:::\n:::\n\n\nWe will import the dataset into a `SpatialExperiment` object. For these exercises, we choose to use the largest bin size of 16 µm, and we will subset the dataset for faster processing during the practicals:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Import Visium HD data from Space Ranger output into a SpatialExperiment object.\nspe <- TENxVisiumHD(\n  spacerangerOut = \"data/Human_Colon_Cancer_P1/\",\n  processing = \"filtered\",\n  format = \"h5\",\n  images = \"lowres\",\n  bin_size = \"016\"\n) |>\n  import()\n\n# we subset the dataset based on x and y coordinates of the tissue slice\nspe <- spe[, spatialCoords(spe)[, 1] * scaleFactors(spe) > 70 &\n  spatialCoords(spe)[, 1] * scaleFactors(spe) < 130 &\n  spatialCoords(spe)[, 2] * scaleFactors(spe) > 200 &\n  spatialCoords(spe)[, 2] * scaleFactors(spe) < 260]\n```\n:::\n\n\n\n::: callout-important\n## Exercise 1b\n\n**What other bin sizes are available? Which is the smallest capture unit and what do the other bin sizes mean? Why wouldn't you always want to work with the smallest available bin?**\n\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Answer\n\nIn `data/Human_Colon_Cancer_P1/binned_outputs` you will find three directories:\n\n```         \nsquare_002um\nsquare_008um\nsquare_016um\n```\n\nThe capture bins are 2µm^2 (adjacent) on the VisiumHD slide, see Fig. 2a in the paper. Larger bins are pools of 2 µm bins (16 bins for an 8 µm bin, 64 bins for a 16 µm bin). Working with those could be handy because the number of molecules captured will be higher, reducing the sparsity of the data at the cost of resolution.\n:::\n\n## Exploring the object\n\nIn this first exercise, we will dive into the `SpatialExperiment` object, a cornerstone of spatial transcriptomics analysis in `R`. We will explore the different components of the loaded object, and perform basic manipulations. By the end of this session, you will have a solid understanding of how to handle spatial transcriptomics data within the `R`/`Bioconductor` ecosystem.\n\n![Overview of the `SpatialExperiment` class structure](../assets/images/spe.png)\n\nThe different slots of the `SpatialExperiment` object can be approached with several accessor functions that correspond to their names. As the `SpatialExperiment` is an extension of the `SingleCellExperiment` class, methods developed to be applied on `SingleCellExperiment` objects (or by extension on `SummarizedExperiment` objects) can also be applied.\n\n::: callout-important\n## Exercise 2\n\nCheck out the outputs of the following functions, that you should already be familiar with:\n\n-   `colData()`\n-   `rowData()`\n-   `assay()`\n-   `reducedDims()`\n\nCheck out the outputs of the following functions, which are specific to the `SpatialExperiment` class:\n\n-   `spatialCoords()`\n-   `imgData()`\n-   `imgRaster()`\n\nQuestions:\n\n-   What kind of data is in the different slots?\n-   How many spots and genes do we have retained in the `spe` object?\n-   Are all spots within the tissue area?\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Answer\n\nThe slot `colData` contains metadata of each of the 14207 spots:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolData(spe) |> head()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDataFrame with 6 rows and 6 columns\n                                    barcode in_tissue array_row array_col\n                                <character> <integer> <integer> <integer>\ns_016um_00144_00175-1 s_016um_00144_00175-1         1       144       175\ns_016um_00204_00145-1 s_016um_00204_00145-1         1       204       145\ns_016um_00191_00159-1 s_016um_00191_00159-1         1       191       159\ns_016um_00111_00233-1 s_016um_00111_00233-1         1       111       233\ns_016um_00202_00235-1 s_016um_00202_00235-1         1       202       235\ns_016um_00102_00186-1 s_016um_00102_00186-1         1       102       186\n                         bin_size   sample_id\n                      <character> <character>\ns_016um_00144_00175-1         016    sample01\ns_016um_00204_00145-1         016    sample01\ns_016um_00191_00159-1         016    sample01\ns_016um_00111_00233-1         016    sample01\ns_016um_00202_00235-1         016    sample01\ns_016um_00102_00186-1         016    sample01\n```\n\n\n:::\n\n```{.r .cell-code}\nncol(spe)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 14207\n```\n\n\n:::\n:::\n\n\nWe have a column `in_tissue` here, and we can check whether spots are covered by the tissue:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolData(spe) |>\n  as.data.frame() |>\n  group_by(in_tissue) |>\n  summarise(number = n())\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 2\n  in_tissue number\n      <int>  <int>\n1         1  14207\n```\n\n\n:::\n:::\n\nThe slot `rowData` contains metadata about the 18085 genes for which we measured expression:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrowData(spe) |> head()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDataFrame with 6 rows and 3 columns\n                             ID      Symbol            Type\n                    <character> <character>        <factor>\nENSG00000187634 ENSG00000187634      SAMD11 Gene Expression\nENSG00000188976 ENSG00000188976       NOC2L Gene Expression\nENSG00000187961 ENSG00000187961      KLHL17 Gene Expression\nENSG00000187583 ENSG00000187583     PLEKHN1 Gene Expression\nENSG00000187642 ENSG00000187642       PERM1 Gene Expression\nENSG00000188290 ENSG00000188290        HES4 Gene Expression\n```\n\n\n:::\n\n```{.r .cell-code}\nnrow(spe)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 18085\n```\n\n\n:::\n:::\n\n\nThe assay is the core count matrix of the object, corresponding to all genes (rows) and all spots (columns):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nassay(spe)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n<18085 x 14207> sparse DelayedMatrix object of type \"integer\":\n                s_016um_00144_00175-1 ... s_016um_00109_00223-1\nENSG00000187634                     0   .                     0\nENSG00000188976                     0   .                     0\nENSG00000187961                     0   .                     0\nENSG00000187583                     0   .                     0\nENSG00000187642                     0   .                     0\n            ...                     .   .                     .\nENSG00000212907                     7   .                     5\nENSG00000198886                    29   .                    15\nENSG00000198786                     0   .                     1\nENSG00000198695                     2   .                     1\nENSG00000198727                    11   .                    11\n```\n\n\n:::\n:::\n\nThe slot for `reducedDims` is empty for now, as we didn't perform any dimensionality reduction calculations yet:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nreducedDims(spe)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nList of length 0\nnames(0): \n```\n\n\n:::\n:::\n\n\nThe slot `spatialCoords` maps each spot to the full resolution image:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspatialCoords(spe) |> head()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                      pxl_col_in_fullres pxl_row_in_fullres\ns_016um_00144_00175-1          10076.365           28256.34\ns_016um_00204_00145-1           8356.073           24733.65\ns_016um_00191_00159-1           9167.045           25500.94\ns_016um_00111_00233-1          13447.496           30216.22\ns_016um_00202_00235-1          13613.955           24899.03\ns_016um_00102_00186-1          10696.244           30716.82\n```\n\n\n:::\n:::\n\nThe slot `imgData` lists all available images linked to the dataset, their resolution and a scaling factor used to convert pixels coordinates relative to the full resolution image coordinates (above). \n\n\n::: {.cell}\n\n```{.r .cell-code}\nimgData(spe)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDataFrame with 1 row and 4 columns\n    sample_id    image_id   data scaleFactor\n  <character> <character> <list>   <numeric>\n1    sample01      lowres   ####  0.00843811\n```\n\n\n:::\n:::\n\n\nThe H&E image can be exported asa raster image for plotting using:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nimgRaster(spe) |> plot()\n```\n\n::: {.cell-output-display}\n![](day1-1_SpatialExperiment_files/figure-html/day1-1-SpatialExperiment-12-1.png){width=672}\n:::\n:::\n\n\n:::\n\nWe saw that the rownames of the object were Ensembl IDs. However, it's more convenient to have gene symbols. Therefore, we replace the Ensembl IDs, with the symbols stored in `rowData` (making sure to keep the ensembl ID if these are not unique):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrownames(spe) <- uniquifyFeatureNames(ID = rowData(spe)$ID, names = rowData(spe)$Symbol)\n```\n:::\n\n\nTo get a visual overview the slide we can use `ggspavis::plotVisium`. First without spots:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplotVisium(spe, spots = FALSE)\n```\n\n::: {.cell-output-display}\n![](day1-1_SpatialExperiment_files/figure-html/day1-1-SpatialExperiment-14-1.png){width=672}\n:::\n:::\n\n\nAnd with spots overlayed:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplotVisium(spe, point_shape = 22, point_size = 0.5)\n```\n\n::: {.cell-output-display}\n![](day1-1_SpatialExperiment_files/figure-html/day1-1-SpatialExperiment-15-1.png){width=672}\n:::\n:::\n\n\n::: callout-important\n## Exercise 3\n\nWhy do we see only spots in a specific area?\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Answer\nAfter loading the object above, we subsetted the dataset for faster processing. Therefore we only see the spots overlayed with the selected area. You can also visualize only the selected area with the `zoom` option, see next exercise.\n\n:::\n\nIt's possible to colour spots according to some variable, e.g., the number of read counts for a selected gene (i.e., PIGR): \n\n\n::: {.cell}\n\n```{.r .cell-code}\nplotVisium(spe,\n  annotate = \"PIGR\",\n  assay = \"counts\",\n  zoom = TRUE,\n  point_size = 1,\n  point_shape = 22\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in guide(title = annotate, order = 1, override.aes = list(col = NA, : Arguments in `...` must be used.\n✖ Problematic argument:\n• override.aes = list(col = NA, size = 3)\nℹ Did you misspell an argument name?\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](day1-1_SpatialExperiment_files/figure-html/day1-1-SpatialExperiment-16-1.png){width=672}\n:::\n:::\n\n::: callout-important\n## Exercise 4\n\nCheck out the usage of `plotVisium` with `?plotVisium`. Create a plot that zooms into the spots, and colors the spots according to column `array_row`.\n\nIn which slot is `array_row` stored and what does it represent?\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Answer\n\nThe column `array_row` is stored in `colData`, it represents in which row the spot is positioned. Of course, plotting this value is not particularly useful for biology. We will visualize more sensible values in the next chapter, when we do the quality control.\n\nWe use the argument `annotate` to color according to a column in `colData`, and we zoom in by specifying `zoom = TRUE`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- plotVisium(spe, annotate = \"array_row\", zoom = TRUE, point_shape = 22)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in guide(title = annotate, order = 1, override.aes = list(col = NA, : Arguments in `...` must be used.\n✖ Problematic argument:\n• override.aes = list(col = NA, size = 3)\nℹ Did you misspell an argument name?\n```\n\n\n:::\n\n```{.r .cell-code}\np\n```\n\n::: {.cell-output-display}\n![](day1-1_SpatialExperiment_files/figure-html/day1-1-SpatialExperiment-17-1.png){width=672}\n:::\n:::\n\n:::\n\n\n\n## Retain only observations that map to tissue \n\n::: callout-important\n## Exercise 5\n\nSubset the SpatialExperiment object (and save it into a new object) to retain only spots that are within the tissue area\n\nHow many spots were present in \"spe\" object? And how many are left after selecting for in-tissue spots only (object sub)?\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Answer\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Subset to in-tissue spots only\nsub <- spe[, colData(spe)$in_tissue]\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Check dimensions of original and subsetted objects\ndim(spe)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 18085 14207\n```\n\n\n:::\n\n```{.r .cell-code}\ndim(sub)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 18085 14207\n```\n\n\n:::\n:::\n\n\nBoth objects have the same dimensions. Our spe object is a subset of tissue slice were all spots map tissue. Therefore the filtering here is not relevant. \n:::\n\n\n## Save the object\n\nSave the filtered `SpatialExperiment` object for the next steps:\n\n::: {.cell}\n\n```{.r .cell-code}\ndir.create(\"results/day1\", showWarnings = FALSE, recursive = TRUE)\nsaveHDF5SummarizedExperiment(spe,\n  dir = \"results/day1\", prefix = \"01.1_spe\", replace = TRUE,\n  chunkdim = NULL, level = NULL, as.sparse = NA,\n  verbose = NA\n)\n```\n:::\n\n\nClear your environment\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrm(list = ls())\ngc()\n.rs.restartR()\n```\n:::\n\n\n::: callout-important\n**Key Takeaways:**\n\n-   The `SpatialExperiment` class is a versatile container for spatial transcriptomics data.\n-   It allows for easy access and manipulation of spatial coordinates, image data, and assay data.\n-   Various operations like subsetting, combining, and image transformations can be performed efficiently.\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}