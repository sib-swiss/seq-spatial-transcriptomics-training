{
  "hash": "e06409be8f3c86621256f1287fbe8809",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Exercise 2\"\nformat: html\neditor: source\neditor_options: \n  chunk_output_type: console\nexecute:\n  warning: false\n---\n\n\n## Quality control at spot-level\n\nIn this second exercise, we will focus on the critical step of quality control (QC) for spatial transcriptomics data. This step focuses on removing low-quality spots or technical artifacts from the dataset to avoid biases into downstream analysis.\n\n\n## Learning objectives\n\nBy the end of this exercise, you will be able to:\n\n- Calculate per-spot QC metrics.\n- Identify local outliers based on various QC metrics.\n- Detect spatial artifacts using `SpotSweeper`.\n- Visualize QC metrics and detected artifacts.\n\n\n## Libraries\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(SpatialExperiment)\nlibrary(SpotSweeper)\nlibrary(scuttle)\nlibrary(scater)\nlibrary(ggside)\nlibrary(ggplot2)\nlibrary(escheR) \nlibrary(HDF5Array)\nlibrary(ggspavis)\nlibrary(patchwork)\n```\n:::\n\n\n## Calculate QC metrics\n\nWe will start by calculating QC metrics that are also commonly used in scRNA-seq data analysis (number of UMI counts per cell, number of detected genes per cell, percentage of UMIs originating from mitochondrial genes). Here these metrics will be calculated per sport, and used to identify low-quality spots.  \n\nWe will start by loading our `SpatialExperiment` object, which was saved in the previous exercise, and prepare it for quality control analysis.  \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the SpatialExperiment object\nspe <- loadHDF5SummarizedExperiment(dir=\"results/day1/\", prefix=\"01.1_spe\")\n\n# Identify mitochondrial genes (genes with symbol starting with \"MT-\")\nis.mito <- rownames(spe)[grepl(\"^MT-\", rownames(spe))]\n```\n:::\n\n\nNow, we will calculate per-spot QC metrics using the `scuttle` package. The function `addPerCellQCMetrics` adds metrics mitochondrial gene percentage to the `colData` of the `SpatialExperiment` object.\n\nRun the following code to compute these metrics and inspect the results. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nspe <- addPerCellQCMetrics(spe, subsets = list(Mito = is.mito))\n```\n:::\n\n\n::: callout-important\n## Exercise 1\n\nCheck which metadata has been added to `colData`. Do you recognize the different metrics?\n:::\n\n:::{.callout-tip collapse=\"true\"}\n### Answer\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Display the colData to see the newly added QC metrics.\ncolData(spe)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDataFrame with 14207 rows and 12 columns\n                                    barcode in_tissue array_row array_col\n                                <character> <integer> <integer> <integer>\ns_016um_00144_00175-1 s_016um_00144_00175-1         1       144       175\ns_016um_00204_00145-1 s_016um_00204_00145-1         1       204       145\ns_016um_00191_00159-1 s_016um_00191_00159-1         1       191       159\ns_016um_00111_00233-1 s_016um_00111_00233-1         1       111       233\ns_016um_00202_00235-1 s_016um_00202_00235-1         1       202       235\n...                                     ...       ...       ...       ...\ns_016um_00217_00238-1 s_016um_00217_00238-1         1       217       238\ns_016um_00192_00176-1 s_016um_00192_00176-1         1       192       176\ns_016um_00214_00240-1 s_016um_00214_00240-1         1       214       240\ns_016um_00193_00227-1 s_016um_00193_00227-1         1       193       227\ns_016um_00109_00223-1 s_016um_00109_00223-1         1       109       223\n                         bin_size   sample_id       sum  detected\n                      <character> <character> <numeric> <integer>\ns_016um_00144_00175-1         016    sample01       322       202\ns_016um_00204_00145-1         016    sample01       253       203\ns_016um_00191_00159-1         016    sample01      1546       982\ns_016um_00111_00233-1         016    sample01       818       665\ns_016um_00202_00235-1         016    sample01       227       195\n...                           ...         ...       ...       ...\ns_016um_00217_00238-1         016    sample01       291       246\ns_016um_00192_00176-1         016    sample01       626       557\ns_016um_00214_00240-1         016    sample01       330       271\ns_016um_00193_00227-1         016    sample01       802       684\ns_016um_00109_00223-1         016    sample01      1020       794\n                      subsets_Mito_sum subsets_Mito_detected\n                             <numeric>             <integer>\ns_016um_00144_00175-1              109                    10\ns_016um_00204_00145-1               37                     7\ns_016um_00191_00159-1              230                    11\ns_016um_00111_00233-1               51                     8\ns_016um_00202_00235-1                7                     5\n...                                ...                   ...\ns_016um_00217_00238-1               10                     6\ns_016um_00192_00176-1                7                     6\ns_016um_00214_00240-1               10                     6\ns_016um_00193_00227-1               19                     7\ns_016um_00109_00223-1               67                    10\n                      subsets_Mito_percent     total\n                                 <numeric> <numeric>\ns_016um_00144_00175-1             33.85093       322\ns_016um_00204_00145-1             14.62451       253\ns_016um_00191_00159-1             14.87710      1546\ns_016um_00111_00233-1              6.23472       818\ns_016um_00202_00235-1              3.08370       227\n...                                    ...       ...\ns_016um_00217_00238-1              3.43643       291\ns_016um_00192_00176-1              1.11821       626\ns_016um_00214_00240-1              3.03030       330\ns_016um_00193_00227-1              2.36908       802\ns_016um_00109_00223-1              6.56863      1020\n```\n\n\n:::\n:::\n\n\n- The `sum` column contains the total number of unique molecular identifiers (UMIs) for each spot\n- The `detected` column contains the number of unique genes detected per spot\n- The `subsets_mito_percent` contains the percentage of transcripts mapping to mitochondrial genes per spot\n:::\n\n\n### Global outlier detection\n\nIn order to detect low-quality spots and filter them out, QC methods adapted from scRNA-seq analysis can be applied. A simple option is to apply a fixed (upper or lower-bound) threshold to a metric across all spots, and remove the spots that do not pass the filtering criteria applied.\n\nTo set up these threshold we can look for information from 10X and the community, for example https://github.com/10XGenomics/HumanColonCancer_VisiumHD/issues/28. Based on this discussion the authors of the OSTA book wrote (see \"Remove bins overlaying empty tissue\" section in https://lmweber.org/OSTA/pages/seq-workflow-visium-hd-bin.html#dependencies): \n\n> Based on a discussion with the original author at 10x Genomics, in this dataset, 8 µm bins with a library size below 100 are removed. Since we expect a 4-fold increase in library size across all bins at 16 µm, we can set the filtering threshold to 400.\n\nWe can also have a look and plot distributions of the values to decide which is the best cutoff:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot library size vs. detected genes\np1 <- ggcells(spe, aes(x=detected, y=sum)) + \n  geom_point() +\n  geom_density_2d() +\n  scale_x_log10() +\n  scale_y_log10() +\n  geom_xsidehistogram() + \n  geom_ysidehistogram() + \n  geom_vline(xintercept = 300, col=\"red\", lty=2) +\n  geom_hline(yintercept = 400, col=\"red\", lty=2) +\n  labs(y=\"Number of UMIs\", x=\"Number of detected genes\") +\n  ggtitle(\"Library size vs. detected\")\n\n# Plot mito proportion vs. detected genes\np2 <- ggcells(spe, aes(x=detected, y=subsets_Mito_percent)) + \n  geom_point() +\n  geom_density_2d() +\n  scale_x_log10() +\n  geom_xsidehistogram() + \n  geom_ysidehistogram() + \n  geom_vline(xintercept = 300, col=\"red\", lty=2) +\n  geom_hline(yintercept = 20, col=\"red\", lty=2) +\n  labs(y=\"% mitochondrial reads\", x=\"Number of detected genes\") +\n  ggtitle(\"Mito proportion vs. genes detected\")\n\np1 + p2\n```\n\n::: {.cell-output-display}\n![](day1-2_spotsweeper_qc_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nAnd further check how many spots would be removed with the given thresholds:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Flag spots based on fixed thresholds\nspe$qc_lib_size <- spe$sum < 400\nspe$qc_detected <- spe$detected < 300\nspe$qc_mito_prop <- spe$subsets_Mito_percent > 20\n\n# Tabulate number of spots flagged by each\nqc <- grep(\"^qc\", names(colData(spe)))\nsapply(colData(spe)[qc], table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      qc_lib_size qc_detected qc_mito_prop\nFALSE       11021       11263        12148\nTRUE         3186        2944         2059\n```\n\n\n:::\n:::\n\n\n::: callout-important\n## Exercise 2\nWhat do you think about this intial filtering? \n\nHave a look at the mitochondrial percentage numbers on the tissue section using `plotVisium()` function. Which spots are more likely to be excluded? \n:::\n\n:::{.callout-tip collapse=\"true\"}\n### Answer\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplotVisium(spe, annotate = \"subsets_Mito_percent\", zoom = TRUE)\n```\n\n::: {.cell-output-display}\n![](day1-2_spotsweeper_qc_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n:::\n\n### Visualize spatial pattern of QC metrics (Global outliers)\n\nVery importantly, we want to have a look into the spatial pattern of using a fixed threshold for QC metrics :\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# check spatial pattern of discarded spots\np1 <- plotObsQC(spe, \n                plot_type=\"spot\", annotate=\"qc_lib_size\") + \n  ggtitle(\"Library size (< 400 UMI)\")\n\np2 <- plotObsQC(spe, \n                plot_type=\"spot\", annotate=\"qc_detected\") + \n  ggtitle(\"Detected genes (< 300 genes)\")\n\np3 <- plotObsQC(spe, \n                plot_type=\"spot\", annotate=\"qc_mito_prop\") + \n  ggtitle(\"Mito proportion (> 20%)\")\n\n# plot the three together\ngridExtra::grid.arrange(p1, p2, p3, ncol=2)\n```\n\n::: {.cell-output-display}\n![](day1-2_spotsweeper_qc_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n### Local Outlier Detection\n\nTo avoid discarding whole layers of tissues, another approach to identify low-quality spots is to use local outlier detection methods that take into account the spatial context of each spot.\n\n`SpotSweeper` package provides functions to identify common QC metrics (such as the ones we have seen in the previous section: library size, number of detected genes, and mitochondrial percentage) and detect local outliers based on these metrics.\n\nWe will use `localOutliers` from `SpotSweeper` which helps identifying spots that deviate significantly from their local neighborhood.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Identify local outliers based on library size (\"sum\" of counts).\n# Spots with unusually low library size compared to their neighbors will be flagged.\nspe <- localOutliers(spe,\n  metric = \"sum\",\n  direction = \"lower\",\n  log = TRUE\n)\n\n# Identify local outliers based on the number of unique genes detected (\"detected\").\n# Spots with an unusually low number of detected genes will be flagged.\nspe <- localOutliers(spe,\n  metric = \"detected\",\n  direction = \"lower\",\n  log = TRUE\n)\n\n# Identify local outliers based on the mitochondrial gene percentage.\n# Spots with an unusually high mitochondrial percentage will be flagged.\nspe <- localOutliers(spe,\n  metric = \"subsets_Mito_percent\",\n  direction = \"higher\",\n  log = FALSE\n)\n\n# Combine all individual outlier flags into a single \"local_outliers\" column.\n# A spot is considered a local outlier if it's flagged by any of the above metrics.\nspe$local_outliers <- as.logical(spe$sum_outliers) |\n  as.logical(spe$detected_outliers) |\n  as.logical(spe$subsets_Mito_percent_outliers)\n```\n:::\n\n\n::: callout-important\n## Exercise 3\nHow many spots were identified as local outliers based on the combined criteria? \n\nAs we have seen before, visualizing the QC metrics is crucial for understanding the quality of your spatial transcriptomics data and for deciding on appropriate filtering strategies, so look at their spatial localization using the `plotObsQC` function.\n\nWhat do you think?\n:::\n\n\n:::{.callout-tip collapse=\"true\"}\n### Answer\n\n::: {.cell}\n\n```{.r .cell-code}\n# Count the number of spots flagged as local outliers.\ntable(spe$local_outliers)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nFALSE  TRUE \n14036   171 \n```\n\n\n:::\n\n```{.r .cell-code}\nplotObsQC(spe, \n          plot_type=\"spot\", annotate=\"local_outliers\") + \n  ggtitle(\"All local outliers\")\n```\n\n::: {.cell-output-display}\n![](day1-2_spotsweeper_qc_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\nEven better, we can visualize the spatial distribution of the local outliers together with the QC metrics, for example plot the spatial distribution of local outliers for mitochondrial percentage.\n\n::: {.cell}\n\n```{.r .cell-code}\nplotQCmetrics(spe,\n  metric = \"subsets_Mito_percent\", outliers = \"subsets_Mito_percent_outliers\",\n  point_size = 0.4,\n  stroke = 0.75\n) +\n  ggtitle(\"Local outliers for %MT\")\n```\n\n::: {.cell-output-display}\n![](day1-2_spotsweeper_qc_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n::: callout-important\n## Exercise 4\nPlot the spatial distribution of local outliers for library size and number of detected genes. What do you observe?\n:::\n\n:::{.callout-tip collapse=\"true\"}\n### Answer\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot the spatial distribution of local outliers for library size.\nplotQCmetrics(spe,\n  metric = \"sum_log\", outliers = \"sum_outliers\", point_size = 0.4,\n  stroke = 0.75\n) +\n  ggtitle(\"Local outliers for number of UMIs\")\n```\n\n::: {.cell-output-display}\n![](day1-2_spotsweeper_qc_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot the spatial distribution of local outliers for number of detected genes.\nplotQCmetrics(spe,\n  metric = \"detected_log\", outliers = \"detected_outliers\", point_size = 0.4,\n  stroke = 0.75\n) +\n  ggtitle(\"Local outliers for number of UMIs\")\n```\n\n::: {.cell-output-display}\n![](day1-2_spotsweeper_qc_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\nVery few spots seem to be flagged as outliers!\n:::\n\n\nWe can visualisaze the z-scores from the local outlier detection test, and compare it to the global threshold used earlier. How do you interpret this?  \n\n::: {.cell}\n\n```{.r .cell-code}\nplotObsQC(spe, plot_type = \"violin\", x_metric = \"subsets_Mito_percent_z\", annotate = \"qc_mito_prop\")\n```\n\n::: {.cell-output-display}\n![](day1-2_spotsweeper_qc_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n## Compare and combine global and local outliers and apply filtering\n\nBased on the comparison of global and local outliers, we choose here to adjust the global cutoffs to be less stringent:\n\nAdjust global filtering cutoffs based on previous plots (apply less stringent cutoffs)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# adjust global filtering cutoff\nspe$qc_lib_size <- spe$sum < 120\nspe$qc_detected <- spe$detected < 100\nspe$qc_mito_prop <- spe$subsets_Mito_percent > 35\n```\n:::\n\n\nCompare global and local outliers being flagged\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspe$global_outliers <- spe$qc_lib_size | spe$qc_detected | spe$qc_mito_prop\np1 <- plotObsQC(spe, plot_type=\"spot\", annotate=\"global_outliers\")\np2 <- plotObsQC(spe, plot_type=\"spot\", annotate=\"local_outliers\")\ngridExtra::grid.arrange(p1, p2, ncol=2)\n```\n\n::: {.cell-output-display}\n![](day1-2_spotsweeper_qc_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\nCombine both:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# combine local and global outliers to create a final discard flag\nspe$discard <- spe$global_outliers | spe$local_outliers\n```\n:::\n\n\n::: callout-important\n## Exercise 5\nVisualise the spots that will be discarded based on the combined criteria. How many spots will be removed?\n:::\n\n:::{.callout-tip collapse=\"true\"}\n### Answer\n\n::: {.cell}\n\n```{.r .cell-code}\n# check how many spots will be discarded\ntable(spe$discard)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nFALSE  TRUE \n12615  1592 \n```\n\n\n:::\n\n```{.r .cell-code}\n# have a final look to the spots that we will discard\nplotVisium(spe, zoom=T, annotate=\"discard\")\n```\n\n::: {.cell-output-display}\n![](day1-2_spotsweeper_qc_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n:::\n\n## Technical artifacts\n\nTechnical artifacts can arise during tissue preparation, for example tissue dissection can cause mechanical damage, leading to large areas with artificially low biological heterogeneity. These can be detected with the `findArtifacts` function of the `spotSweeper` package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# find artifacts using SpotSweeper\nspe <- findArtifacts(spe,\n    mito_percent = \"subsets_Mito_percent\",\n    mito_sum = \"subsets_Mito_sum\",\n    n_order = 5,\n    name = \"artifact\"\n)\n```\n:::\n\n\n::: callout-important\n## Exercise 6\nWhat is the `findArtifacts` function performing and what are the (potentially problematic) assumptions?\n:::\n\n::: callout-important\n## Exercise 7\nPlot the spatial distribution of the `artifact` column identified by `SpotSweeper`. What do you observe?\n\n:::{.callout-tip collapse=\"true\"}\n### Answer\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot the spatial distribution of the detected artifacts.\nplotQCmetrics(spe,\n    metric = \"subsets_Mito_percent\", # You can choose any relevant metric to display\n    outliers = \"artifact\", \n    point_size = 1.1\n) +\n    ggtitle(\"Detected Spatial Artifacts\")\n```\n\n::: {.cell-output-display}\n![](day1-2_spotsweeper_qc_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n:::\n\n## Filtering \nWe decide to filter out the low-quality spots from the `SpatialExperiment` object based on the combined criteria of global thresholds and local outliers. Additionally, we will remove any features (genes) that have zero counts across all remaining spots.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# remove the spots considered of low quality based on both global and local metrics\nspe <- spe[, !spe$discard]\n\n# remove features with all 0 counts\nspe <- spe[rowSums(counts(spe)) > 0, ]\n```\n:::\n\n\nWhat is the size of the dataset after filtering?\n\n## Save the object\n\nSave the filtered `SpatialExperiment` object for the next steps:\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveHDF5SummarizedExperiment(spe, dir=\"results/day1\", prefix=\"01.2_spe\", replace=TRUE,\n                                chunkdim=NULL, level=NULL, as.sparse=NA,\n                                verbose=NA)\n```\n:::\n\n\nClear your environment:\n\n::: {.cell}\n\n```{.r .cell-code}\nrm(list = ls())\ngc()\n.rs.restartR()\n```\n:::\n\n\n:::{.callout-important}\n**Key Takeaways:**\n\n-   `scuttle::addPerCellQCMetrics` provides essential per-spot QC metrics.\n-   `SpotSweeper::localOutliers` helps identify individual problematic spots.\n-   `SpotSweeper::findArtifacts` is powerful for detecting spatially coherent regions of poor quality.\n-   Visualizing QC results is critical for data interpretation and downstream analysis decisions.\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}